{% extends 'shop/_layouts/main' %}

{% block main %}
  <div class="flex -mx-8">
    <div class="w-2/3 px-8">
      <h1 class="font-bold text-xl">How would you like to pay?</h1>
      <div class="text-xs block sm:inline text-gray-300 tracking-widest font-mono">templates/{{ _self }}.twig</div>

      {# Get the available payment sources the user has to be used later in this page. #}
      {% set paymentSources = craft.commerce.paymentSources.allPaymentSourcesByUserId(currentUser.id ?? null) %}

      {# Get the available gateways to be used later in this page #}
      {% set availableGateways = craft.commerce.gateways.allCustomerEnabledGateways %}

      {# If there are no gateway then payment sources wont work either, so lets #}
      {% if availableGateways is empty %}
        <p>No payment methods available.</p>
      {% endif %}

      {% if availableGateways|length %}
        <div class="mt-3">
          <form method="post" action="" class="relative border-b-1 mb-4">
            <input type="hidden" name="action" value="commerce/cart/update-cart">
            {{ redirectInput('shop/checkout/payment') }}
            {{ csrfInput() }}

            <label class="font-semibold">Choose a payment gateway or payment source:</label>
            {% if paymentSources|length %}
              {% for source in paymentSources %}
                <label class="block bg-gray-100 p-2 hover:bg-gray-200 cursor-pointer mt-3">
                  <div class="flex justify-start items-center">
                    <div class="pr-2">
                      <input type="radio" name="paymentSourceId" value="{{ source.id }}" {% if source.id == cart.paymentSourceId %}checked{% endif %} />
                    </div>
                    <div>
                      <strong>{{ storedCard.description }}</strong>
                      <br><span class="text-gray-600">Stored source</span>
                    </div>
                  </div>
                </label>
              {% endfor %}
            {% endif %}

            {% for id,name in availableGateways %}
              <label class="block bg-gray-100 p-2 hover:bg-gray-200 cursor-pointer mt-3">
                <div class="flex justify-start items-center">
                  <div class="pr-2">
                    <input type="radio" name="gatewayId" value="{{ id }}" {% if id == cart.gatewayId %}checked{% endif %} />
                  </div>
                  <div>
                    <strong>{{ name }}</strong>
                  </div>
                </div>
              </label>
            {% endfor %}

            {% set currencies = craft.commerce.paymentCurrencies.allPaymentCurrencies %}
            {% if currencies|length > 1 %}
              <label class="block font-semibold mt-6">Choose payment currency:</label>
              {% for currency in currencies %}
                <label class="block bg-gray-100 p-2 hover:bg-gray-200 cursor-pointer mt-3">
                  <div class="flex justify-start items-center">
                    <div class="pr-2">
                      <input type="radio" name="paymentCurrency" value="{{ currency.iso }}" {% if currency.iso == cart.paymentCurrency %}checked{% endif %} />
                    </div>
                    <div>
                      <strong>{{ currency.name }} {{  currency.iso }}</strong><br>
                      <span class="text-gray-600">{{ cart.totalPrice|commerceCurrency(currency.iso,convert=true) }}</span>
                    </div>
                  </div>
                </label>
              {% endfor %}
            {% endif %}

            <div class="mt-6 flex justify-end">
              <input class="{{ classes.btn.base ~ ' ' ~ classes.btn.blue }}" type="submit" name="submit" value="Next" />
            </div>
          </form>
        </div>
      {% endif %}
    </div>
    <div class="w-1/3 pr-8">
      {% include "shop/checkout/_includes/order-summary" with { showShippingAddress: true, showShippingMethod: true } %}
    </div>
  </div>
{% endblock %}

{% js %}
    var $paymentSources = document.querySelectorAll('[name="paymentSourceId"]');
    var hasPaymentSources = $paymentSources && $paymentSources.length > 0;
    var $gateways = document.querySelectorAll('[name="gatewayId"]');
    var hasGateways = $gateways && $gateways.length > 0;

    if (hasPaymentSources && hasGateways) {
        function deselectPaymentSources() {
            $paymentSources.forEach(function(el) {
                el.checked = false;
            });
        }

        function deselectGateways() {
            $gateways.forEach(function(el) {
                el.checked = false;
            });
        }

        $paymentSources.forEach(function(el) {
            el.addEventListener('change', function(ev) {
                deselectGateways();
            });
        });

        $gateways.forEach(function(el) {
            el.addEventListener('change', function(ev) {
                deselectPaymentSources();
            });
        });
    }

{% endjs %}