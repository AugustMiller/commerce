{% extends "shop/_layouts/main" %}

{% block main %}
  <h1 class="text-3xl block sm:inline">Cart</h1>
  <span class="text-xs block sm:inline text-gray-300 tracking-widest font-mono">templates/{{ _self }}/index.twig</span>

    {% if cart.lineItems|length %}
        <table class="w-full mt-4">
            <thead>
            <tr class="text-gray-600 bg-gray-200">
                <th class="py-2 pl-3 text-left w-1/3">Product</th>
                <th class="py-2 text-left">Qty</th>
                <th class="py-2 pr-3 text-right">Price</th>
            </tr>
            </thead>
            <form method="post" action="">
                <input type="hidden" name="action" value="commerce/cart/update-cart">
                <input type="hidden" name="cartUpdatedNotice" value="The cart was updated.">
                {{ redirectInput('shop/cart') }}
                {{ csrfInput() }}
            <tbody>
                {% set lineItemHasErrors = false %}
                {% for item in cart.lineItems %}
                    {% if item.hasErrors() %}
                        {# if the line item has errors lets record it so we can hide totals later (since they wont make sense) #}
                        {% set lineItemHasErrors = true %}
                    {% endif %}
                    <tr class="align-top {% if item.hasErrors() %}bg-red-600{% endif %}">
                        <td class="py-3 pl-3 {{ not loop.first ? 'border-t border-gray-300 border-dashed' : '' }}" rowspan="2">
                            <strong class="text-lg">{{ item.description }}</strong><br>
                            <span class="text-gray-500 tracking-widest font-mono text-xs">{{ item.sku }}</span>
                            <div class="mt-2 relative">
                              <code class="text-xs p-3 pt-8 bg-gray-100 inline-block tracking-wider font-mono text-gray-600">{{ item.options|length ? item.options|json_encode : 'no options.' }}</code>
                              <span class="absolute top-0 left-0 pt-2 pl-2 text-2xs text-gray-500 uppercase tracking-wider">Options</span>
                            </div>
                            <div class="mt-6">
                              <label>
                                <input type="checkbox"
                                       name="lineItems[{{ item.id }}][remove]"
                                       value="1"> Remove Line
                              </label>
                            </div>
                        </td>
                        <td class="py-3 {{ not loop.first ? 'border-t border-gray-300 border-dashed' : '' }}">
                            {% if item.options.giftWrapped is defined %}
                            <select name="lineItems[{{ item.id }}][options][giftWrapped]">
                                <option value="no"
                                        {% if item.options.giftWrapped == 'no' %}selected{% endif %}>
                                    No gift wrap
                                </option>
                                <option value="yes"
                                        {% if item.options.giftWrapped == 'yes' %}selected{% endif %}>
                                    Gift wrapped.
                                </option>
                            </select>
                            {% endif %}

                            {% if item.options.donationAmount is defined %}
                            <input type="text" name="lineItems[{{ item.id }}][options][donationAmount]" placeholder="Donation" value="{{item.options.donationAmount}}">
                            {% endif %}

                            <input type="text" placeholder="My Note"
                                   size="20"
                                   name="lineItems[{{ item.id }}][note]"
                                   value="{{ item.note }}">

                            <span {% if item.getFirstError('qty') %}class="has-error"{% endif %}>
                              <input class="border border-gray-200 hover:border-gray-500 px-4 py-2 leading-tight rounded"
                                  type="{% if item.options.donationAmount is defined %}hidden{%else%}number{%endif%}" name="lineItems[{{ item.id }}][qty]" min="0" value="{{ item.qty }}">
                            </span>

                        </td>

                        <td class="py-3 pr-3 text-gray-500 {{ not loop.first ? 'border-t border-gray-300 border-dashed' : '' }} text-right">
                            {% if not lineItemHasErrors %}
                                <div class="flex items-center w-full justify-end" title="{{ item.price }}">
                                  <div class="text-xs pr-2">Price:</div>
                                  <div class="text-sm">{% if item.onSale %}<del>{% endif %}{{ item.price|commerceCurrency(cart.currency) }}{% if item.onSale %}</del>{% endif %}</div>
                                </div>
                                {% if item.onSale %}
                                  <div class="flex items-center w-full justify-end" title="{{ item.salePrice }}">
                                    <div class="text-xs pr-2">Sale Price:</div>
                                    <div class="text-sm">{{ item.salePrice|commerceCurrency(cart.currency) }}</div>
                                  </div>
                                  <div class="flex items-center w-full justify-end" title="{{ item.saleAmount }}">
                                    <div class="text-xs pr-2">Sale Amount:</div>
                                    <div class="text-sm">{{ item.saleAmount|commerceCurrency(cart.currency) }}</div>
                                  </div>

                                  {% set itemSales = item.snapshot.sales ?? [] %}
                                  {% if itemSales|length %}
                                    <div class="flex w-full justify-end">
                                      <div class="text-xs pr-2">Sales Applied:</div>
                                      <div class="text-xs">
                                        {% for sale in itemSales %}
                                          {{ sale.name }}<br>
                                        {% endfor %}
                                      </div>
                                    </div>
                                  {% endif %}
                                {% else %}
                                {% endif %}
                                <div class="flex items-center w-full justify-end" title="{{ item.subtotal }}">
                                  <div class="text-xs pr-2">Subtotal:</div>
                                  <div class="text-sm">{{ item.subtotal|commerceCurrency(cart.currency) }}</div>
                                </div>
                            {% endif %}
                        </td>
                    </tr>
                    <tr class="">
                      <td class="pb-3 pr-3 text-right" colspan="2">
                        {% if not lineItemHasErrors and item.adjustments|length %}
                            <div class="text-left text-2xs uppercase tracking-wider text-gray-600">Adjustments</div>
                            <div class="border-t border-gray-300 border-dotted mt-1">
                              {% for adjustment in item.adjustments %}
                                  <div class="flex w-full items-center mt-2 text-sm">
                                    <div class="pr-2">
                                      <strong class="text-gray-400 text-xs uppercase">{{ adjustment.type }}</strong>
                                    </div>
                                    <div class="">
                                      {{ adjustment.name }}
                                      {% if adjustment.isEstimated %}<i class="text-grey-dark">{{ 'Estimated' }}</i>{% endif %}<br>
                                      {{ adjustment.description }}
                                    </div>
                                    <div class="ml-auto">
                                      <span class="text-gray-500" title="{{ adjustment.amount }}"> {{ adjustment.amount|commerceCurrency(cart.currency) }}</span>
                                    </div>
                                  </div>
                              {% endfor %}
                            </div>

                        {% endif %}

                        <div class="flex items-center w-full justify-end mt-3" title="{{ item.total }}">
                          <div class="text-sm text-gray-600 pr-2">Total:</div>
                          <div class="font-bold">{{ item.total|commerceCurrency(cart.currency) }}</div>
                        </div>
                      </td>
                    </tr>
                {% endfor %}

                {% if not lineItemHasErrors %}
                    {% for adjustment in cart.orderAdjustments %}
                        <tr class="adjustment">
                            <td>{{ adjustment.type }}</td>
                            <td>
                                <strong>{{ adjustment.name }}</strong>{% if adjustment.isEstimated %}<br><i class="text-grey-dark">{{ 'Estimated' }}</i>{% endif %}<br>({{ adjustment.description }}
                                )
                            </td>
                            <td class="text-right"><span title="{{ adjustment.amount }}">{{ adjustment.amount|commerceCurrency(cart.currency) }}</span></td>
                        </tr>
                    {% endfor %}
                {% endif %}
                <tr>
                    <td colspan="2" class="border-t-2 border-gray-300 ">
                      {% if not cart.getShippingAddress() %}
                      <div class="p-6 max-w-sm">
                        <h5 class="mt-0">{{ 'Shipping Estimate' }}</h5>

                        <div class="js-estimate-fields">
                          {% set countries = craft.commerce.countries.allEnabledCountriesAsList %}
                          {% set states = craft.commerce.states.allEnabledStatesAsListGroupedByCountryId %}
                          <label class="m-0" for="estimatedShippingAddress-countryId">{{ 'Country' }}</label>
                          <select class="js-address-country w-full js-estimate-country" name="estimatedShippingAddress[countryId]" data-modelname="estimatedShippingAddress">
                            {% for key, option in countries %}
                              {% set optionValue = (cart.estimatedShippingAddress ? cart.estimatedShippingAddress.countryId : '') %}
                              <option value="{{ key }}" {% if key == optionValue %} selected{% endif %}>{{ option }}</option>
                            {% endfor %}
                          </select>

                          <div class="js-estimate-state-box" data-modelname="estimatedShippingAddress">
                            <label class="mb-0 mt-2" for="estimatedShippingAddress-state">{{ 'State' }}</label>
                            {% set options = (cart.estimatedShippingAddress and states[cart.estimatedShippingAddress.countryId] is defined ? states[cart.estimatedShippingAddress.countryId] : []) %}
                            <select id="estimatedShippingAddress-stateId" data-modelname="estimatedShippingAddress" class="address-stateId w-full {% if options|length == 0 %}hidden{% endif %}" name="estimatedShippingAddress[stateValue]">
                              {% for key, option in options %}
                                {% set optionValue = (cart.estimatedShippingAddress ? cart.estimatedShippingAddress.stateId : '') %}
                                <option value="{{ key }}" {% if key == optionValue %}selected{% endif %}>{{ option }}</option>
                              {% endfor %}
                            </select>
                            <input type="text" data-modelname="estimatedShippingAddress" id="estimatedShippingAddress-stateName" class="address-stateName {% if options|length > 0 %}hidden{% endif %} w-full" {% if options|length == 0 %}name="estimatedShippingAddress[stateValue]"{% endif %} value="{{ cart.estimatedShippingAddress ? cart.estimatedShippingAddress.stateName : '' }}">
                          </div>

                          <label class="mb-0 mt-2" for="estimatedShippingAddress-zipCode">{{ 'Zip Code' }}</label>
                          <input type="text" id="estimatedShippingAddress-zipCode" class="w-full" name="estimatedShippingAddress[zipCode]" value="{{ cart.estimatedShippingAddress ? cart.estimatedShippingAddress.zipCode : '' }}">

                          <div class="mt-6">
                            <label class="m-0">
                              <input type="checkbox" name="estimatedBillingAddressSameAsShipping" value="1" {% if cart.estimatedShippingAddressId == cart.estimatedBillingAddressId %}checked{% endif %}> {{ 'Billing Same as Shipping' }}
                            </label>
                          </div>

                          <div class="js-estimate-billing mt-6">
                            <h5 class="mt-0">{{ 'Tax Estimate' }}</h5>
                            <label class="mb-0 mt-2" for="estimatedBillingAddress-countryId">{{ 'Country' }}</label>
                            <select class="js-address-country w-full js-estimate-country" name="estimatedBillingAddress[countryId]" data-modelname="estimatedBillingAddress">
                              {% for key, option in countries %}
                                {% set optionValue = (cart.estimatedBillingAddress ? cart.estimatedBillingAddress.countryId : '') %}
                                <option value="{{ key }}" {% if key == optionValue %} selected{% endif %}>{{ option }}</option>
                              {% endfor %}
                            </select>

                            <div class="js-estimate-state-box" data-modelname="estimatedBillingAddress">
                              <label class="mb-0 mt-2" for="estimatedBillingAddress-state">{{ 'State' }}</label>
                              {% set options = (cart.estimatedBillingAddress and states[cart.estimatedBillingAddress.countryId] is defined ? states[cart.estimatedBillingAddress.countryId] : []) %}
                              <select id="estimatedBillingAddress-stateId" data-modelname="estimatedBillingAddress" class="address-stateId w-full {% if options|length == 0 %}hidden{% endif %}" name="estimatedBillingAddress[stateValue]">
                                {% for key, option in options %}
                                  {% set optionValue = (cart.estimatedBillingAddress ? cart.estimatedBillingAddress.stateId : '') %}
                                  <option value="{{ key }}" {% if key == optionValue %}selected{% endif %}>{{ option }}</option>
                                {% endfor %}
                              </select>
                              <input type="text" data-modelname="estimatedBillingAddress" id="estimatedBillingAddress-stateName" class="address-stateName {% if options|length > 0 %}hidden{% endif %} w-full" {% if options|length == 0 %}name="estimatedBillingAddress[stateValue]"{% endif %} value="{{ cart.estimatedBillingAddress ? cart.estimatedBillingAddress.stateName : '' }}">
                            </div>

                            <label class="mb-0 mt-2" for="estimatedBillingAddress-zipCode">{{ 'Zip Code' }}</label>
                            <input type="text" id="estimatedBillingAddress-zipCode" class="w-full" name="estimatedBillingAddress[zipCode]" value="{{ cart.estimatedBillingAddress ? cart.estimatedBillingAddress.zipCode : '' }}">
                          </div>
                        </div>

                        {# Shipping Methods #}
                          <div class="js-estimate-shipping-methods">
                            {% if cart.availableShippingMethods|length and cart.estimatedShippingAddressId %}
                              <div class="mt-3">
                                {% for handle, method in cart.availableShippingMethods %}
                                  <div class="js-shipping-select">
                                    <label>
                                      <input type="radio" name="shippingMethodHandle" value="{{ handle }}" {% if handle == cart.shippingMethodHandle %}checked{% endif %} />
                                      <strong>{{ method.name }}</strong>
                                      <span class="price"><span title="{{ method.priceForOrder(cart) }}"></span> {{ method.priceForOrder(cart)|commerceCurrency(cart.currency) }}</span>
                                    </label>
                                  </div>
                                {% endfor %}
                              </div>
                              <div class="mt-6">
                                <a class="js-estimate-show-fields" href="#">{{ 'Show Estimate Fields' }}</a>
                              </div>
                            {% endif %}
                          </div>
                      </div>
                      {% endif %}
                    </td>
                    <td class="text-right align-text-top border-t-2 border-gray-300 pt-3">
                        {% if not lineItemHasErrors %}
                            <div class="flex items-center w-full justify-end" title="{{ cart.itemSubTotal }}">
                              <div class="text-sm text-gray-600 pr-2">Item Subtotal:</div>
                              <div class="font-bold">{{ cart.itemSubTotal|commerceCurrency(cart.currency) }}</div>
                            </div>

                            <div class="mt-3">
                              <strong class="text-sm text-gray-600">Adjustment Totals</strong>
                            </div>

                            <div class="flex items-center w-full justify-end" title="{{ cart.getTotalDiscount() }}">
                              <div class="text-xs text-gray-500 pr-2">Total Discount:</div>
                              <div class="text-sm text-gray-500">{{ cart.getTotalDiscount()|commerceCurrency(cart.currency) }}</div>
                            </div>
                            <div class="flex items-center w-full justify-end" title="{{ cart.getTotalShippingCost() }}">
                              <div class="text-xs text-gray-500 pr-2">Total Shipping:</div>
                              <div class="text-sm text-gray-500">{{ cart.getTotalShippingCost()|commerceCurrency(cart.currency) }}</div>
                            </div>
                            <div class="flex items-center w-full justify-end" title="{{ cart.getTotalTax() }}">
                              <div class="text-xs text-gray-500 pr-2">Total Tax:</div>
                              <div class="text-sm text-gray-500">{{ cart.getTotalTax()|commerceCurrency(cart.currency) }}</div>
                            </div>
                            <div class="flex items-center w-full justify-end" title="{{ cart.getTotalTaxIncluded() }}">
                              <div class="text-xs text-gray-500 pr-2">Total Tax (inc):</div>
                              <div class="text-sm text-gray-500">{{ cart.getTotalTaxIncluded()|commerceCurrency(cart.currency) }}</div>
                            </div>

                            <div class="flex items-center w-full justify-end mt-3" title="{{ cart.totalPrice }}">
                              <div class="text-gray-600 pr-2">Total Price:</div>
                              <div class="text-xl font-bold">{{ cart.totalPrice|commerceCurrency(cart.currency) }}</div>
                            </div>
                        {% endif %}
                    </td>
                </tr>
                <tr>

                    <td class="text-right" colspan="3">
                      <div class="flex w-full justify-end">

                        <div class="bg-gray-100 border-b-2 border-gray-300 p-4 text-left max-w-sm w-full">
                          {# Update Coupon form uses the single update controller action: #}
                          <h5>Coupon Code</h5>
                          {% if cart.getFirstError('couponCode') %}
                            <span class="flash">{{ cart.getFirstError('couponCode') }}</span>
                          {% endif %}

                          <span class="{% if cart.getFirstError('couponCode') %}has-error{% endif %}">
                          <input type="text" name="couponCode" width="11"
                             class="{% if cart.getFirstError('couponCode') %}has-error{% endif %}"
                             value="{{ cart.couponCode }}"
                             placeholder="{{ "Coupon Code" }}">
                          </span>
                        </div>
                      </div>
                      <div class="pt-3">
                        <input class="right" type="submit" value="Update Cart"/>
                      </div>
                    </td>
                </tr>
                <tr>
                    <td colspan="3" class="text-right">
                        {% if not lineItemHasErrors %}
                            <a class="checkout-button button button-primary" href="{{ url('shop/checkout') }}">Checkout</a>
                        {% endif %}
                    </td>
                </tr>
            </tbody>
            </form>
        </table>
    {% endif %}

    {% if not cart.lineItems|length %}
        <p>You have no items in your cart, add some on the <a href="{{ url('shop/products') }}">products page</a>.</p>
    {% endif %}
  {% js %}
    var states = {{ craft.commerce.states.allEnabledStatesAsListGroupedByCountryId|json_encode|raw }};
  {% endjs %}
  {% js %}
    var $estimateShippingMethodsContainer = $('.js-estimate-shipping-methods');
    var $estimateFieldsContainer = $('.js-estimate-fields');
    var $estimateShowFieldsButton = $('.js-estimate-show-fields');
    var $estimateBilling = $('.js-estimate-billing');
    var $estimateBillingSameAsShipping = $('input[name="estimatedBillingAddressSameAsShipping"]');
    var $estimateCountrySelects = $('select.js-estimate-country');

    // Setup "same as" checkbox
    if ($estimateBillingSameAsShipping.prop('checked')) {
        $estimateBilling.addClass('hidden').find('input,select').attr('disabled', 'disabled').prop('disabled', 'disabled');
    }

    // Handle the change event for the "same as" checkbox
    $estimateBillingSameAsShipping.change(function(ev) {
        var $this = $(this);
        if ($this.prop('checked')) {
            $estimateBilling.addClass('hidden').find('input,select').attr('disabled', 'disabled').prop('disabled', 'disabled');
        } else {
            $estimateBilling.removeClass('hidden').find('input,select').attr('disabled', '').prop('disabled', '');
        }
    });

    // Setup initial state Showing/hiding of the shipping method selection
    if ($estimateShippingMethodsContainer.find('.js-shipping-select').length) {
        $estimateFieldsContainer.addClass('hidden');
        $estimateFieldsContainer.find('input,select').attr('disabled', 'disabled').prop('disabled', 'disabled');
    } else {
        $estimateShippingMethodsContainer.addClass('hidden');
        $estimateShippingMethodsContainer.find('input,select').attr('disabled', 'disabled').prop('disabled', 'disabled');;
    }

    // Handle click event for returning to the estimate fields
    $estimateShowFieldsButton.click(function(ev) {
        ev.preventDefault();

        if ($estimateFieldsContainer.hasClass('hidden')) {
            $estimateFieldsContainer.removeClass('hidden');
            $estimateFieldsContainer.find('input,select').attr('disabled', '').prop('disabled', '');
            $estimateShippingMethodsContainer.addClass('hidden');
            $estimateShippingMethodsContainer.find('input,select').attr('disabled', 'disabled').prop('disabled', 'disabled');
        } else {
            $estimateFieldsContainer.addClass('hidden');
            $estimateFieldsContainer.find('input,select').attr('disabled', 'disabled').prop('disabled', 'disabled');
            $estimateShippingMethodsContainer.removeClass('hidden');
            $estimateShippingMethodsContainer.find('input,select').attr('disabled', '').prop('disabled', '');
        }
    });

    // Handle change event for country selection for both shipping and billing
    $estimateCountrySelects.change(function () {
        // get the value of the selected country.
        var cid = $(this).val();
        var $box = $('.js-estimate-state-box[data-modelname="'+$(this).data('modelname')+'"]');
        var $states = $box.find('select.js-address-stateId');
        var $stateName = $box.find('input.js-address-stateName');
        $states.find('option').remove();

        if (states.hasOwnProperty(cid))
        {
            // We have states for this country, show the states drop down.
            $states.removeClass('hidden');
            $states.attr('name', $states.data('modelname')+'[stateValue]');

            // We have states for this country, hide the stateName input.
            $stateName.removeAttr('name');
            $stateName.addClass('hidden');
            $stateName.val('');

            // Add all states as options to drop down.
            for (var id in states[cid])
            {
                var state = states[cid][id];
                var $option = $('<option/>');
                $option.attr('value', id).text(state);
                $states.append($option);
            }

        }else{
            // hide the states dropdown, since this country has none.
            $states.addClass('hidden');
            $states.removeAttr('name');

            // show the stateName
            $stateName.removeClass('hidden');
            $stateName.attr('name', $stateName.data('modelname')+'[stateValue]');
        }

    });
  {% endjs %}
{% endblock %}
